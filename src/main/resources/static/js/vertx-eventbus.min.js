!function(e){if("function"==typeof require&&"undefined"!=typeof module){var r=require("sockjs-client");if(!r)throw Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");e(r)}else if("function"==typeof define&&define.amd)define("vertx-eventbus",["sockjs"],e);else{if(void 0===this.SockJS)throw Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");EventBus=e(this.SockJS)}}(function(e){function r(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e,r){return r=16*Math.random(),("y"==e?3&r|8:0|r).toString(16)})}function s(e,r){if(e){if(!r)return e;for(var s in e)e.hasOwnProperty(s)&&void 0===r[s]&&(r[s]=e[s])}return r||{}}var n=function(r,s){var t=this;s=s||{},this.pingInterval=s.vertxbus_ping_interval||5e3,this.pingTimerID=null,this.sockJSConn=new e(r,null,s),this.state=n.CONNECTING,this.handlers={},this.replyHandlers={},this.defaultHeaders=null,this.onerror=function(e){try{console.error(e)}catch(r){}},this.sockJSConn.onopen=function(){t.pingEnabled(!0),t.state=n.OPEN,t.onopen&&t.onopen()},this.sockJSConn.onclose=function(e){t.state=n.CLOSED,t.pingTimerID&&clearInterval(t.pingTimerID),t.onclose&&t.onclose(e)},this.sockJSConn.onmessage=function(e){var r=JSON.parse(e.data);if(r.replyAddress&&Object.defineProperty(r,"reply",{value:function(e,s,n){t.send(r.replyAddress,e,s,n)}}),t.handlers[r.address])for(var s=t.handlers[r.address],n=0;n<s.length;n++)"err"===r.type?s[n]({failureCode:r.failureCode,failureType:r.failureType,message:r.message}):s[n](null,r);else if(t.replyHandlers[r.address]){var i=t.replyHandlers[r.address];delete t.replyHandlers[r.address],"err"===r.type?i({failureCode:r.failureCode,failureType:r.failureType,message:r.message}):i(null,r)}else if("err"===r.type)t.onerror(r);else try{console.warn("No handler found for message: ",r)}catch(e){}}};return n.prototype.send=function(e,t,i,o){if(this.state!=n.OPEN)throw Error("INVALID_STATE_ERR");"function"==typeof i&&(o=i,i={});var a={type:"send",address:e,headers:s(this.defaultHeaders,i),body:t};if(o){var d=r();a.replyAddress=d,this.replyHandlers[d]=o}this.sockJSConn.send(JSON.stringify(a))},n.prototype.publish=function(e,r,t){if(this.state!=n.OPEN)throw Error("INVALID_STATE_ERR");this.sockJSConn.send(JSON.stringify({type:"publish",address:e,headers:s(this.defaultHeaders,t),body:r}))},n.prototype.registerHandler=function(e,r,t){if(this.state!=n.OPEN)throw Error("INVALID_STATE_ERR");"function"==typeof r&&(t=r,r={}),this.handlers[e]||(this.handlers[e]=[],this.sockJSConn.send(JSON.stringify({type:"register",address:e,headers:s(this.defaultHeaders,r)}))),this.handlers[e].push(t)},n.prototype.unregisterHandler=function(e,r,t){if(this.state!=n.OPEN)throw Error("INVALID_STATE_ERR");var i=this.handlers[e];if(i){"function"==typeof r&&(t=r,r={});var o=i.indexOf(t);-1!=o&&(i.splice(o,1),0===i.length&&(this.sockJSConn.send(JSON.stringify({type:"unregister",address:e,headers:s(this.defaultHeaders,r)})),delete this.handlers[e]))}},n.prototype.close=function(){this.state=n.CLOSING,this.sockJSConn.close()},n.CONNECTING=0,n.OPEN=1,n.CLOSING=2,n.CLOSED=3,n.prototype.pingEnabled=function(e){var r=this;if(e){var s=function(){r.sockJSConn.send(JSON.stringify({type:"ping"}))};r.pingInterval>0&&(s(),r.pingTimerID=setInterval(s,r.pingInterval))}else r.pingTimerID&&(clearInterval(r.pingTimerID),r.pingTimerID=null)},"undefined"==typeof exports?n:void("undefined"!=typeof module&&module.exports?exports=module.exports=n:exports.EventBus=n)});