!function(e){if("function"==typeof require&&"undefined"!=typeof module){var n=require("sockjs-client");if(!n)throw Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");e(n)}else if("function"==typeof define&&define.amd)define("vertx-eventbus",["sockjs"],e);else{if(void 0===this.SockJS)throw Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");EventBus=e(this.SockJS)}}(function(e){function n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e,n){return n=16*Math.random(),("y"==e?3&n|8:0|n).toString(16)})}function r(e,n){if(e){if(!n)return e;for(var r in e)e.hasOwnProperty(r)&&void 0===n[r]&&(n[r]=e[r])}return n||{}}var t=function(n,r){var s=this;r=r||{},this.pingInterval=r.vertxbus_ping_interval||5e3,this.pingTimerID=null,this.reconnectInterval=r.vertxbus_reconnect_interval||0,this.reconnectTimerID=null,this.defaultHeaders=null,this.onerror=function(e){try{console.error(e)}catch(n){}};var o=function(){s.sockJSConn=new e(n,null,r),s.state=t.CONNECTING,s.handlers={},s.replyHandlers={};var i;s.reconnectTimerID?(clearInterval(s.reconnectTimerID),i=!0):i=!1,s.sockJSConn.onopen=function(){s.pingEnabled(!0),s.state=t.OPEN,s.onopen&&s.onopen(),i&&s.onreconnect&&s.onreconnect()},s.sockJSConn.onclose=function(e){s.state=t.CLOSED,s.pingTimerID&&clearInterval(s.pingTimerID),s.reconnectInterval>0&&(s.sockJSConn=null,s.reconnectTimerID=setInterval(function(){o()},s.reconnectInterval)),s.onclose&&s.onclose(e)},s.sockJSConn.onmessage=function(e){var n=JSON.parse(e.data);if(n.replyAddress&&Object.defineProperty(n,"reply",{value:function(e,r,t){s.send(n.replyAddress,e,r,t)}}),s.handlers[n.address])for(var r=s.handlers[n.address],t=0;t<r.length;t++)"err"===n.type?r[t]({failureCode:n.failureCode,failureType:n.failureType,message:n.message}):r[t](null,n);else if(s.replyHandlers[n.address]){var o=s.replyHandlers[n.address];delete s.replyHandlers[n.address],"err"===n.type?o({failureCode:n.failureCode,failureType:n.failureType,message:n.message}):o(null,n)}else if("err"===n.type)s.onerror(n);else try{console.warn("No handler found for message: ",n)}catch(e){}}};o()};return t.prototype.send=function(e,s,o,i){if(this.state!=t.OPEN)throw Error("INVALID_STATE_ERR");"function"==typeof o&&(i=o,o={});var a={type:"send",address:e,headers:r(this.defaultHeaders,o),body:s};if(i){var l=n();a.replyAddress=l,this.replyHandlers[l]=i}this.sockJSConn.send(JSON.stringify(a))},t.prototype.publish=function(e,n,s){if(this.state!=t.OPEN)throw Error("INVALID_STATE_ERR");this.sockJSConn.send(JSON.stringify({type:"publish",address:e,headers:r(this.defaultHeaders,s),body:n}))},t.prototype.registerHandler=function(e,n,s){if(this.state!=t.OPEN)throw Error("INVALID_STATE_ERR");"function"==typeof n&&(s=n,n={}),this.handlers[e]||(this.handlers[e]=[],this.sockJSConn.send(JSON.stringify({type:"register",address:e,headers:r(this.defaultHeaders,n)}))),this.handlers[e].push(s)},t.prototype.unregisterHandler=function(e,n,s){if(this.state!=t.OPEN)throw Error("INVALID_STATE_ERR");var o=this.handlers[e];if(o){"function"==typeof n&&(s=n,n={});var i=o.indexOf(s);-1!=i&&(o.splice(i,1),0===o.length&&(this.sockJSConn.send(JSON.stringify({type:"unregister",address:e,headers:r(this.defaultHeaders,n)})),delete this.handlers[e]))}},t.prototype.close=function(){this.state=t.CLOSING,this.sockJSConn.close()},t.CONNECTING=0,t.OPEN=1,t.CLOSING=2,t.CLOSED=3,t.prototype.pingEnabled=function(e){var n=this;if(e){var r=function(){n.sockJSConn.send(JSON.stringify({type:"ping"}))};n.pingInterval>0&&(r(),n.pingTimerID=setInterval(r,n.pingInterval))}else n.pingTimerID&&(clearInterval(n.pingTimerID),n.pingTimerID=null)},"undefined"==typeof exports?t:void("undefined"!=typeof module&&module.exports?exports=module.exports=t:exports.EventBus=t)});